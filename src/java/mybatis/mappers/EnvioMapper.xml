<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="envio">

    <select id="obtenerEnvio" resultType="pojo.Envio">
    CALL ObtenerEnvios();
   </select>


    <select id="obtenerNumerosGuias" resultType="pojo.Envio">
    select numeroGuia  
    from envio e;
   </select>
   <select id="obtenerEnvioNoGuia" resultType="pojo.Envio">
           SELECT e.numeroGuia, s.status,e.idEnvio,s.modificacion,
       CONCAT(c2.nombre, ' ', c2.apellidoMaterno, ' ', c2.apellidoPaterno) AS conductor,
       CONCAT(do.calle, ' ', do.numero, ' ', do.colonia, ' ', do.codigoPostal, ' ', do.ciudad, ' ', do.estado) AS origen,
       CONCAT(d2.calle, ' ', d2.numero, ' ', d2.colonia, ' ', d2.codigoPostal, ' ', d2.estado, ' ', d2.ciudad) AS destino
    FROM envio e
    INNER JOIN direcciondestino d2 ON d2.idDestino = e.idDestino
    INNER JOIN DireccionOrigen do ON do.idOrigen = e.idOrigen
    INNER JOIN asociacionenvio a ON a.idEnvio = e.idEnvio
    INNER JOIN statusenvio s ON s.idEnvio = e.idEnvio
    INNER JOIN conductor c ON c.idConductor = a.idConductor
    INNER JOIN colaborador c2 ON c2.idColaborador = c.idConductor
    WHERE e.numeroGuia = #{numeroGuia};
   </select>

   <select id="obtenerEnvioNoLicencia" resultType="pojo.Envio">
    SELECT e.numeroGuia, s.status,
       CONCAT(c2.nombre, ' ', c2.apellidoMaterno, ' ', c2.apellidoPaterno) AS `repartidor`,
       CONCAT(do.calle, ' ', do.numero, ' ', do.colonia, ' ', do.codigoPostal, ' ', do.ciudad, ' ', do.estado) AS `origen`,
       CONCAT(d2.calle, ' ', d2.numero, ' ', d2.colonia, ' ', d2.codigoPostal, ' ', d2.estado, ' ', d2.ciudad) AS `destino`
    FROM envio e
    INNER JOIN direcciondestino d2 ON d2.idDestino = e.idDestino
    INNER JOIN DireccionOrigen do ON do.idOrigen = e.idOrigen
    INNER JOIN asociacionenvio a ON a.idEnvio = e.idEnvio
    INNER JOIN statusenvio s ON s.idEnvio = e.idEnvio
    INNER JOIN conductor c ON c.idConductor = a.idConductor
    INNER JOIN colaborador c2 ON c2.idColaborador = c.idConductor
    WHERE c.numeroLicencia = #{numeroLicencia};
</select> 
    <select id="obtenerEstatus" resultType="pojo.Envio">
    SELECT se.idStatus, se.idEnvio, se.status,se.motivo,se.modificacion
    FROM StatusEnvio se
    WHERE se.idEnvio = #{idEnvio};
    </select>

    <insert id="cambiarStatus" parameterType="map"> 
      INSERT INTO statusenvio (idEnvio, status,motivo,modificacion)
      VALUES (#{idEnvio},#{status},#{motivo},NOW());
   </insert>
        
    <insert id="registrarEnvio" parameterType="pojo.Envio" >
     CALL CrearEnvio(
        
        #{idCliente},
        #{calleOrigen},
        #{numeroOrigen},
        #{coloniaOrigen},
        #{codigoPostalOrigen},
        #{ciudadOrigen},
        #{estadoOrigen},
        #{calleDestino},
        #{numeroDestino},
        #{coloniaDestino},
        #{codigoPostalDestino},
        #{ciudadDestino},
        #{estadoDestino},
        #{costo},
        #{idColaborador}
        );
        
        
        
        
    </insert>

    <update id="editarEnvio" statementType="CALLABLE" parameterType="pojo.Envio">
        CALL ActualizarEnvio(
            #{idEnvio},
            #{idOrigen},
            #{idDestino},
            #{calleOrigen},
            #{numeroOrigen},
            #{coloniaOrigen},
            #{ciudadOrigen},
            #{estadoOrigen},
            #{calleDestino},
            #{numeroDestino},
            #{codigoPostalOrigen},
            #{codigoPostalDestino},
            #{coloniaDestino},
            #{ciudadDestino},
            #{estadoDestino},
            #{costo}
        )
    
    </update>
    
    <delete id="eliminarEnvioId" parameterType="pojo.Envio">
        DELETE
        FROM Envio
        WHERE idEnvio = #{idEnvio}
    </delete>

</mapper>